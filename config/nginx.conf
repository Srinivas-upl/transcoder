events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Add MIME types for streaming
    location ~ \.m3u8$ {
        add_header Cache-Control no-cache;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
        add_header Content-Type application/vnd.apple.mpegurl;
    }

    location ~ \.ts$ {
        add_header Cache-Control "public, max-age=3600";
        add_header Access-Control-Allow-Origin *;
        add_header Content-Type video/mp2t;
    }

    location ~ \.mpd$ {
        add_header Cache-Control no-cache;
        add_header Access-Control-Allow-Origin *;
        add_header Content-Type application/dash+xml;
    }

    location ~ \.(mp4|m4s)$ {
        add_header Cache-Control "public, max-age=3600";
        add_header Access-Control-Allow-Origin *;
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            root /usr/share/nginx/html;
            index index.html;

            # Enable CORS for all requests
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
            add_header Access-Control-Allow-Headers DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range;

            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
                add_header Access-Control-Allow-Headers DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range;
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type 'text/plain; charset=utf-8';
                add_header Content-Length 0;
                return 204;
            }

            # Enable range requests for video seeking
            add_header Accept-Ranges bytes;
        }

        # Admin interface
        location /admin {
            alias /usr/share/nginx/html/admin;
            try_files $uri $uri/ /admin/index.html;
        }

        # Serve streaming files with appropriate headers
        location /hls/ {
            alias /usr/share/nginx/html/hls/;
        }

        location /dash/ {
            alias /usr/share/nginx/html/dash/;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
}
